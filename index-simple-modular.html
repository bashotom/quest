<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamischer Fragebogen - Modular Simple</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale@4"></script>
    
    <!-- Chart Library -->
    <script src="js/radarChart.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
            min-height: 100vh;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            Fragebogen wird geladen...
        </div>
        
        <div id="error" class="error" style="display: none;">
            <strong>Fehler:</strong> <span id="error-message"></span>
        </div>
        
        <div id="app-content" style="display: none;">
            <!-- Navigation Menu -->
            <nav class="mb-6">
                <div class="flex flex-wrap justify-center gap-4 mb-4">
                    <ul class="flex flex-wrap justify-center gap-4" id="questionnaire-menu">
                        <!-- Links werden per JS eingefügt -->
                    </ul>
                </div>
                <div class="flex justify-center">
                    <div class="flex flex-wrap justify-center gap-2">
                        <button id="min-answers-btn" type="button" class="border border-blue-300 bg-white hover:bg-blue-50 text-blue-700 font-medium py-1.5 px-3 rounded transition duration-150">Alle Minimalwerte</button>
                        <button id="random-answers-btn" type="button" class="border border-blue-300 bg-white hover:bg-blue-50 text-blue-700 font-medium py-1.5 px-3 rounded transition duration-150">Alle Zufallswerte</button>
                        <button id="max-answers-btn" type="button" class="border border-blue-300 bg-white hover:bg-blue-50 text-blue-700 font-medium py-1.5 px-3 rounded transition duration-150">Alle Maximalwerte</button>
                    </div>
                </div>
            </nav>
            
            <!-- Meta Information -->
            <div class="mb-6 text-center">
                <h1 id="questionnaire-title" class="text-3xl font-bold text-gray-800 mb-2"></h1>
                <p id="questionnaire-description" class="text-gray-600"></p>
            </div>
            
            <!-- Form Container -->
            <div id="form-container">
                <!-- Questionnaire Form wird hier eingefügt -->
            </div>
            
            <!-- Evaluation Container -->
            <div id="evaluation-container" style="display: none;">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Auswertung</h2>
                <div class="flex justify-center mb-6">
                    <div id="radarChart" style="width: 100%; max-width: 600px; height: 400px;"></div>
                </div>
                <div class="text-center">
                    <button id="back-to-form" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                        Zurück zum Fragebogen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { QuestionnaireLoader } from './services/questionnaire-loader.js';
        import { URLHashManager } from './utils/url-hash-manager.js';

        let questions = [];
        let config = {};
        let currentFolder = '';

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app-content').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        function showContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
        }

        function showForm() {
            document.getElementById('form-container').style.display = 'block';
            document.getElementById('evaluation-container').style.display = 'none';
        }

        function showEvaluation() {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('evaluation-container').style.display = 'block';
        }

        function renderMenu() {
            const menu = document.getElementById('questionnaire-menu');
            menu.innerHTML = '';
            const folders = QuestionnaireLoader.getQuestionnaireFolders();
            
            folders.forEach(folder => {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = `?q=${folder.folder}`;
                link.textContent = folder.name;
                link.className = `px-4 py-2 rounded-lg ${folder.folder === currentFolder ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`;
                link.addEventListener('click', (e) => handleMenuNavigation(e, folder.folder));
                li.appendChild(link);
                menu.appendChild(li);
            });
        }

        function renderForm() {
            const container = document.getElementById('form-container');
            container.innerHTML = `
                <div class="mb-4 flex justify-center gap-4">
                    <button type="button" id="btn-column" class="border border-blue-300 bg-blue-600 text-white font-medium py-1 px-3 rounded transition duration-150">Tabellen-Modus</button>
                    <button type="button" id="btn-inline" class="border border-blue-300 bg-white hover:bg-blue-100 text-blue-700 font-medium py-1 px-3 rounded transition duration-150">Karten-Modus</button>
                </div>
                <form id="questionnaire-form">
                    <div class="mb-8 flex justify-center">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                            Fragebogen auswerten
                        </button>
                    </div>
                    <div id="questions-container"></div>
                    <div class="mt-8 flex justify-center">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                            Fragebogen auswerten
                        </button>
                    </div>
                </form>
            `;

            renderQuestions();
            setupFormEvents();
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            const displayMode = localStorage.getItem('displayMode') || 'column';

            if (displayMode === 'column') {
                renderTableMode(container);
            } else {
                renderInlineMode(container);
            }

            // Antworten aus Hash setzen
            URLHashManager.setAnswersFromHash(questions);
        }

        function renderTableMode(container) {
            let html = `
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-gray-500">Frage</th>
            `;

            config.answers.forEach(answer => {
                html += `<th class="px-4 py-3 text-center font-medium text-gray-500">${answer.label}</th>`;
            });

            html += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            questions.forEach(question => {
                html += `<tr><td class="px-4 py-3">${question.text}</td>`;
                
                config.answers.forEach((answer, index) => {
                    html += `
                        <td class="px-4 py-3 text-center cursor-pointer hover:bg-gray-50" onclick="selectRadio('${question.id}', '${index}')">
                            <input type="radio" name="question-${question.id}" value="${index}" class="mx-auto">
                        </td>
                    `;
                });
                
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function renderInlineMode(container) {
            let html = '<div class="space-y-6">';

            questions.forEach(question => {
                html += `
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="font-medium mb-4">${question.text}</div>
                        <div class="flex flex-wrap gap-4">
                `;

                config.answers.forEach((answer, index) => {
                    html += `
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="question-${question.id}" value="${index}">
                            <span>${answer.label}</span>
                        </label>
                    `;
                });

                html += '</div></div>';
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function setupFormEvents() {
            // Display mode buttons
            document.getElementById('btn-column')?.addEventListener('click', () => {
                localStorage.setItem('displayMode', 'column');
                renderQuestions();
                updateButtonStyles();
            });

            document.getElementById('btn-inline')?.addEventListener('click', () => {
                localStorage.setItem('displayMode', 'inline');
                renderQuestions();
                updateButtonStyles();
            });

            // Form submission
            document.getElementById('questionnaire-form')?.addEventListener('submit', handleFormSubmit);

            // Answer buttons
            document.getElementById('min-answers-btn')?.addEventListener('click', () => setAllAnswers('min'));
            document.getElementById('random-answers-btn')?.addEventListener('click', () => setAllAnswers('random'));
            document.getElementById('max-answers-btn')?.addEventListener('click', () => setAllAnswers('max'));

            // Back button
            document.getElementById('back-to-form')?.addEventListener('click', () => {
                showForm();
                window.history.replaceState(null, null, window.location.pathname + window.location.search);
            });

            updateButtonStyles();
        }

        function updateButtonStyles() {
            const mode = localStorage.getItem('displayMode') || 'column';
            const btnColumn = document.getElementById('btn-column');
            const btnInline = document.getElementById('btn-inline');

            if (btnColumn && btnInline) {
                if (mode === 'column') {
                    btnColumn.className = 'border border-blue-300 bg-blue-600 text-white font-medium py-1 px-3 rounded transition duration-150';
                    btnInline.className = 'border border-blue-300 bg-white hover:bg-blue-100 text-blue-700 font-medium py-1 px-3 rounded transition duration-150';
                } else {
                    btnColumn.className = 'border border-blue-300 bg-white hover:bg-blue-100 text-blue-700 font-medium py-1 px-3 rounded transition duration-150';
                    btnInline.className = 'border border-blue-300 bg-blue-600 text-white font-medium py-1 px-3 rounded transition duration-150';
                }
            }
        }

        function setAllAnswers(mode) {
            questions.forEach(question => {
                const radios = document.querySelectorAll(`input[name="question-${question.id}"]`);
                if (radios.length === 0) return;

                let targetRadio;
                switch (mode) {
                    case 'min': targetRadio = radios[0]; break;
                    case 'max': targetRadio = radios[radios.length - 1]; break;
                    case 'random': targetRadio = radios[Math.floor(Math.random() * radios.length)]; break;
                }

                if (targetRadio) {
                    targetRadio.checked = true;
                }
            });
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            
            const answers = URLHashManager.collectAnswersFromForm(questions);
            const scores = URLHashManager.calculateScores(answers, questions, config.answers);
            
            // Update hash
            URLHashManager.updateHash(answers);
            
            // Render chart
            renderChart(scores);
            showEvaluation();
        }

        function renderChart(scores) {
            const container = document.getElementById('radarChart');
            container.innerHTML = '';

            // Chart-Typ aus Konfiguration
            let chartType = config.chart?.type || 'radar';

            if (chartType === 'radar' && typeof window.RadarChart === 'function') {
                // Berechne die Maximalwerte pro Kategorie
                const categoryMaxScores = {};
                Object.keys(config.categories).forEach(category => {
                    const categoryQuestions = questions.filter(q => q.category === category);
                    const maxAnswer = Math.max(...config.answers.map(a => a.value));
                    categoryMaxScores[category] = categoryQuestions.length * maxAnswer;
                });

                // Normalisierte Daten für RadarChart
                const data = Object.keys(config.categories).map(key => {
                    const value = scores[key] || 0;
                    const maxForCategory = categoryMaxScores[key];
                    return (value / maxForCategory) * 100;
                });

                const chartData = [
                    Object.keys(config.categories).map((key, index) => ({
                        axis: { key: key, value: config.categories[key] },
                        value: data[index]
                    }))
                ];

                const options = {
                    w: 500,
                    h: 400,
                    maxValue: 100,
                    levels: 5,
                    roundStrokes: true,
                    color: d3.scaleOrdinal().range(["#3b82f6"]),
                    format: '.0f',
                    unit: '%',
                    config: config
                };

                window.RadarChart('#radarChart', chartData, options);
            } else {
                // Fallback
                let html = '<div class="bg-white border rounded-lg p-6"><h3 class="text-lg font-bold mb-4">Ergebnisse:</h3><ul class="space-y-2">';
                Object.entries(scores).forEach(([category, score]) => {
                    const categoryName = config.categories[category] || category;
                    html += `<li><strong>${categoryName}:</strong> ${score}</li>`;
                });
                html += '</ul></div>';
                container.innerHTML = html;
            }
        }

        function handleMenuNavigation(event, folder) {
            event.preventDefault();
            
            const url = new URL(window.location);
            url.searchParams.set('q', folder);
            window.history.pushState(null, null, url);
            
            currentFolder = folder;
            loadQuestionnaire();
        }

        function handleHashChange() {
            const scores = URLHashManager.parseScoresFromHash(questions);
            if (scores) {
                renderChart(scores);
                showEvaluation();
            } else {
                showForm();
                URLHashManager.setAnswersFromHash(questions);
            }
        }

        async function loadQuestionnaire() {
            try {
                currentFolder = QuestionnaireLoader.getActiveQuestionnaire();
                const data = await QuestionnaireLoader.loadQuestionnaire(currentFolder);
                
                questions = data.questions;
                config = data.config;
                
                // Update UI
                document.getElementById('questionnaire-title').textContent = config.title;
                document.getElementById('questionnaire-description').textContent = config.description;
                
                renderMenu();
                renderForm();
                
                // Check for existing answers in hash
                const scores = URLHashManager.parseScoresFromHash(questions);
                if (scores) {
                    renderChart(scores);
                    showEvaluation();
                } else {
                    showForm();
                }
                
                showContent();
                
            } catch (error) {
                console.error('Error loading questionnaire:', error);
                showError(error.message);
            }
        }

        // Global selectRadio function for table mode
        window.selectRadio = function(qid, aval) {
            const radio = document.querySelector(`input[name='question-${qid}'][value='${aval}']`);
            if (radio) {
                radio.checked = true;
            }
        };

        // Event listeners
        URLHashManager.onHashChange(handleHashChange);

        // Initialize app
        loadQuestionnaire();
    </script>
</body>
</html>
